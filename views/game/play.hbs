<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f12;
            --card-bg: #1a1a20;
            --accent: #6d5dfc;
            --text-main: #ffffff;
            --text-dim: #a0a0ab;
            --success: #30ff6a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
        }

        .glass {
            background: rgba(26, 26, 32, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #editor-container {
            height: calc(100vh - 120px);
        }
    </style>
</head>

<body class="h-screen flex flex-col">
    <header class="h-16 glass flex items-center justify-between px-8 border-b border-white/10 z-50">
        <div class="flex items-center gap-4">
            <a href="/game/map/{{quest.topic}}/{{quest.difficulty}}"
                class="p-2 hover:bg-white/5 rounded-xl transition-all">
                <i data-lucide="arrow-left"></i>
            </a>
            <h1 class="font-bold text-lg flex items-center gap-3">
                <span class="text-[var(--accent)] font-black">QUEST:</span>
                {{quest.title}}
            </h1>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 text-sm font-semibold">
                <i data-lucide="zap" class="text-yellow-500 w-4 h-4"></i>
                <span>{{quest.points}} Points</span>
            </div>
            <button id="btn-skip"
                class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-xs font-bold border border-white/10 transition-all flex items-center gap-2 {{#if (eq user.skipCredits 0)}}opacity-50 cursor-not-allowed{{/if}}">
                <i data-lucide="fast-forward" class="w-3 h-3"></i>
                SKIP ({{user.skipCredits}})
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Sidebar: Description -->
        <div class="w-1/3 p-8 overflow-y-auto border-r border-white/10 bg-[#0f0f12]">
            <div class="mb-8">
                <span
                    class="px-3 py-1 bg-[#6d5dfc1a] text-[#6d5dfc] text-[10px] font-black uppercase rounded-lg border border-[#6d5dfc33]">
                    {{quest.difficulty}}
                </span>
            </div>
            <div class="prose prose-invert max-w-none">
                <p class="text-[var(--text-dim)] leading-relaxed text-lg">
                    {{quest.description}}
                </p>
            </div>

            <div id="results-panel" class="mt-12 hidden">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="check-circle-2" class="text-[var(--success)]"></i>
                    Results
                </h3>
                <div id="test-cases-list" class="space-y-3">
                    <!-- Dynamic Test Cases -->
                </div>
            </div>
        </div>

        <!-- Editor -->
        <div class="flex-1 flex flex-col relative">
            <div id="editor-container" class="w-full"></div>

            <div class="absolute bottom-8 right-8 z-50 flex gap-4">
                <button id="btn-run"
                    class="px-8 py-3 bg-[#1a1a20] border border-white/10 text-white font-bold rounded-2xl hover:bg-[#25252e] transition-all flex items-center gap-2">
                    <i data-lucide="play" class="w-4 h-4 text-[var(--accent)]"></i>
                    Run Code
                </button>
                <button id="btn-professor"
                    class="px-8 py-3 bg-[#1a1a20] border border-white/10 text-white font-bold rounded-2xl hover:bg-[#25252e] transition-all flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-4 h-4 text-yellow-500"></i>
                    Ask Professor
                </button>
                <button id="btn-submit"
                    class="px-10 py-3 bg-[var(--accent)] text-white font-bold rounded-2xl shadow-xl shadow-[#6d5dfc44] hover:scale-105 transition-all">
                    Submit Challenge
                </button>
            </div>
        </div>
    </main>

    <!-- Professor Hint Modal -->
    <div id="professor-panel"
        class="fixed top-24 right-8 w-80 glass p-6 rounded-3xl shadow-2xl z-50 hidden border-l-4 border-l-yellow-500">
        <div class="flex justify-between items-start mb-4">
            <h4 class="font-black text-xs uppercase tracking-tighter text-yellow-500 flex items-center gap-2">
                <i data-lucide="graduation-cap" class="w-4 h-4"></i>
                Professor's Hint
            </h4>
            <button onclick="document.getElementById('professor-panel').classList.add('hidden')"
                class="opacity-50 hover:opacity-100">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <p id="professor-hint-text" class="text-sm italic text-[var(--text-dim)] leading-relaxed"></p>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="glass p-12 rounded-[40px] text-center relative z-10 max-w-sm w-full mx-4 shadow-2xl scale-90 opacity-0 transition-all duration-300 transform"
            id="modal-content">
            <div
                class="w-24 h-24 bg-[var(--success)]/10 text-[var(--success)] rounded-full flex items-center justify-center mx-auto mb-8 shadow-lg shadow-[#30ff6a22]">
                <i data-lucide="trophy" class="w-12 h-12"></i>
            </div>
            <h2 class="text-3xl font-black mb-2">CONGRATS!</h2>
            <p class="text-[var(--text-dim)] mb-8">You mastered this challenge and earned <strong>{{quest.points}}
                    points</strong>.</p>
            <button id="btn-next"
                class="w-full py-4 bg-[var(--success)] text-black font-black rounded-2xl hover:scale-105 transition-all">
                NEXT LEVEL
            </button>
        </div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        let editor;

        require(['vs/editor/editor.main'], function () {
            monaco.editor.defineTheme('game-theme', {
                base: 'vs-dark',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#0f0f12',
                }
            });

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: `{{{quest.template}}}`,
                language: 'javascript',
                theme: 'game-theme',
                fontSize: 16,
                fontFamily: 'JetBrains Mono',
                minimap: { enabled: false },
                automaticLayout: true,
                padding: { top: 40 },
                lineNumbers: 'on',
                renderLineHighlight: 'all',
                scrollBeyondLastLine: false,
            });
        });

        const questId = '{{quest.id}}';
        const csrfToken = '{{csrfToken}}';

        async function submitCode() {
            const code = editor.getValue();
            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Checking...';
            lucide.createIcons();

            try {
                const res = await fetch('/api/game/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId, code })
                });
                const data = await res.json();

                showResults(data);

                if (data.success) {
                    showSuccess();
                }
            } catch (err) {
                alert('Connection error');
            } finally {
                btnSubmit.innerText = 'Submit Challenge';
            }
        }

        function showResults(data) {
            const panel = document.getElementById('results-panel');
            const list = document.getElementById('test-cases-list');
            panel.classList.remove('hidden');
            list.innerHTML = '';

            data.results.forEach((res, i) => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-xl border ${res.passed ? 'bg-[#30ff6a10] border-[#30ff6a22]' : 'bg-red-500/10 border-red-500/22'} flex items-center justify-between`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="${res.passed ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${res.passed ? 'text-[#30ff6a]' : 'text-red-500'}"></i>
                        <span class="text-xs font-bold uppercase opacity-60">Case ${i + 1}</span>
                    </div>
                    <span class="text-sm font-mono font-bold">${res.passed ? 'PASSED' : 'FAILED'}</span>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        function showSuccess() {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6d5dfc', '#30ff6a', '#ffffff']
            });

            const modal = document.getElementById('success-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-90', 'opacity-0');
            }, 10);
        }

        document.getElementById('btn-submit').onclick = submitCode;

        document.getElementById('btn-skip').onclick = async () => {
            if ({{ user.skipCredits }
        } <= 0) {
            alert('No skip credits left! Complete 5 quests to earn 1 skip.');
            return;
        }

        if (confirm('Use 1 skip credit to pass this level?')) {
            try {
                const res = await fetch('/api/game/skip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId })
                });
                if (res.ok) {
                    window.location.href = '/game/map/{{quest.topic}}/{{quest.difficulty}}';
                } else {
                    const data = await res.json();
                    alert(data.error || 'Skip failed');
                }
            } catch (err) {
                alert('Connection error');
            }
        }
        };

        document.getElementById('btn-professor').onclick = async () => {
            const code = editor.getValue();
            const panel = document.getElementById('professor-panel');
            const text = document.getElementById('professor-hint-text');

            text.innerText = 'Analyzing your logic...';
            panel.classList.remove('hidden');

            try {
                const res = await fetch('/api/game/hint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId, code })
                });
                const data = await res.json();
                text.innerText = data.hint || 'Even professors have bad days.';
            } catch (err) {
                text.innerText = 'Professor is currently out for lunch.';
            }
        };

        document.getElementById('btn-next').onclick = () => {
            window.location.href = '/game/map/{{quest.topic}}/{{quest.difficulty}}';
        };

        lucide.createIcons();
    </script>
</body>

</html>