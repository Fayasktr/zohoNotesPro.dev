<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Prettier for "Pretty" code formatting (Must load BEFORE Monaco to avoid AMD conflict) -->
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/standalone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@2.8.8/parser-babel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0c;
            --pane-bg: #111114;
            --accent: #6d5dfc;
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #e1e1e6;
            --text-dim: #8e8e99;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
        }

        .pane {
            background-color: var(--pane-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        #editor-container {
            flex: 1;
            min-height: 0;
        }

        .output-line {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding: 4px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        #master-chat {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 380px;
            height: 500px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        #master-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 10px 20px rgba(109, 93, 252, 0.3);
            transition: transform 0.2s;
        }

        #master-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>

<body class="h-screen flex flex-col p-4 gap-4">
    <!-- Header -->
    <header class="flex items-center justify-between px-2">
        <div class="flex items-center gap-4">
            <a href="/game/map/{{quest.topic}}" class="p-2 hover:bg-white/5 rounded-lg transition-all">
                <i data-lucide="chevron-left"></i>
            </a>
            <div>
                <div class="flex items-center gap-2">
                    <span
                        class="px-2 py-0.5 bg-[var(--accent)]/20 text-[var(--accent)] text-[10px] font-black rounded uppercase tracking-wider">Mission
                        {{questIndex}} of {{totalQuests}}</span>
                    <h1 class="font-bold text-xs text-[var(--text-dim)] uppercase tracking-widest">{{quest.topic}}</h1>
                </div>
                <h2 class="font-black text-xl">{{quest.title}}</h2>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="px-4 py-2 bg-white/5 rounded-xl border border-white/5 flex items-center gap-2">
                <i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i>
                <span class="font-bold">{{quest.points}} pts</span>
            </div>
            <button id="btn-skip"
                class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-xs font-bold border border-white/5 {{#if (eq user.skipCredits 0)}}opacity-50{{/if}}">
                SKIP ({{user.skipCredits}})
            </button>
            <button id="btn-submit"
                class="px-6 py-2 bg-[var(--accent)] text-white font-black rounded-xl hover:opacity-90 transition-all">
                SUBMIT
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex gap-4 min-h-0">
        <!-- Left Pane: Description -->
        <div class="w-1/3 pane flex flex-col overflow-hidden">
            <div class="flex-1 flex flex-col overflow-hidden">
                <div
                    class="p-4 border-b border-[var(--border)] flex items-center gap-2 text-xs font-bold text-[var(--text-dim)]">
                    <i data-lucide="graduation-cap" class="w-3 h-3 text-[var(--accent)]"></i> LEARN
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar prose prose-invert max-w-none border-b border-[var(--border)] bg-white/[0.02]"
                    id="explanation-content">
                    {{{quest.explanation}}}
                </div>

                <div
                    class="p-4 border-b border-[var(--border)] flex items-center gap-2 text-xs font-bold text-[var(--text-dim)]">
                    <i data-lucide="terminal" class="w-3 h-3"></i> MISSION
                </div>
                <div class="flex-1 p-6 overflow-y-auto custom-scrollbar prose prose-invert max-w-none"
                    id="description-content">
                    {{{quest.description}}}
                </div>
            </div>
        </div>

        <!-- Center Pane: Editor & Console -->
        <div class="flex-1 flex flex-col gap-4">
            <!-- Editor Pane -->
            <div class="flex-[2] pane flex flex-col overflow-hidden">
                <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs font-bold text-[var(--text-dim)]">
                        <i data-lucide="code-2" class="w-3 h-3"></i> EDITOR
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btn-format" title="Format Code (Pretty)"
                            class="flex items-center gap-2 px-3 py-1 bg-white/5 hover:bg-white/10 rounded-md text-[10px] font-black border border-white/5">
                            <i data-lucide="sparkles" class="w-3 h-3 text-pink-400"></i> PRETTY
                        </button>
                        <button id="btn-run"
                            class="flex items-center gap-2 px-3 py-1 bg-white/5 hover:bg-white/10 rounded-md text-[10px] font-black border border-white/5">
                            <i data-lucide="play" class="w-3 h-3 text-[var(--accent)]"></i> RUN
                        </button>
                    </div>
                </div>
                <div id="editor-container"></div>
            </div>

            <!-- Console Pane -->
            <div class="flex-1 pane flex flex-col overflow-hidden">
                <div class="p-4 border-b border-[var(--border)] flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs font-bold text-[var(--text-dim)]">
                        <i data-lucide="terminal" class="w-3 h-3"></i> CONSOLE
                    </div>
                    <button onclick="document.getElementById('console-output').innerHTML=''"
                        class="text-[10px] opacity-50 hover:opacity-100">CLEAR</button>
                </div>
                <div id="console-output" class="flex-1 p-4 overflow-y-auto custom-scrollbar font-mono text-sm">
                    <div class="text-[var(--text-dim)] italic">Output will appear here...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Master Assistant -->
    <div id="master-btn" title="Ask The Master">
        <i data-lucide="sparkles"></i>
    </div>

    <div id="master-chat" class="pane glass">
        <div class="p-4 border-b border-[var(--border)] flex items-center justify-between bg-[var(--accent)]/10">
            <div class="flex items-center gap-2 text-xs font-black">
                <i data-lucide="shield-check" class="w-4 h-4 text-[var(--accent)]"></i> THE MASTER
            </div>
            <button id="close-master" class="opacity-50 hover:opacity-100"><i data-lucide="x"
                    class="w-4 h-4"></i></button>
        </div>
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-4 text-sm">
            <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                Greetings, seeker. I am The Master. I will teach you the logic, but I will never give you the answer.
                How can I guide you?
            </div>
        </div>
        <div class="p-4 border-t border-[var(--border)] flex gap-2">
            <input type="text" id="chat-input" placeholder="Ask about logic..."
                class="flex-1 bg-white/5 border border-white/5 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[var(--accent)]">
            <button id="send-chat" class="p-2 bg-[var(--accent)] rounded-lg"><i data-lucide="send"
                    class="w-4 h-4"></i></button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-[2000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="pane p-8 text-center relative z-10 max-w-sm w-full mx-4 shadow-2xl">
            <div
                class="w-20 h-20 bg-green-500/10 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="award" class="w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-black mb-2">MASTERED!</h2>
            <p class="text-[var(--text-dim)] text-sm mb-6">Logic verified. You earned <strong>{{quest.points}}
                    points</strong>.</p>
            <button id="btn-next"
                class="w-full py-3 bg-[var(--accent)] text-white font-black rounded-xl hover:opacity-90 transition-all">NEXT
                CHALLENGE</button>
        </div>
    </div>

    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        let editor;
        const questId = '{{quest.id}}';
        const csrfToken = '{{csrfToken}}';

        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: `{{{quest.template}}}`,
                language: 'javascript',
                theme: 'vs-dark',
                fontSize: 14,
                fontFamily: 'JetBrains Mono',
                minimap: { enabled: false },
                automaticLayout: true,
                padding: { top: 20 },
                lineNumbers: 'on',
                scrollBeyondLastLine: false,
                backgroundColor: '#111114'
            });

            // Render MD description
            const desc = document.getElementById('description-content');
            desc.innerHTML = marked.parse(desc.innerText);
        });

        // Console Logic & Global Error Interception
        const originalLog = console.log;
        const out = document.getElementById('console-output');

        const smartStringify = (val, maxDepth = 5, seen = new WeakSet()) => {
            if (val === null) return "null";
            if (val === undefined) return "undefined";
            if (typeof val === "string") return `"${val}"`;
            if (typeof val !== "object" && typeof val !== "function") return String(val);

            if (maxDepth < 0) return "[...]";
            if (seen.has(val)) return "[Circular]";
            seen.add(val);

            if (Array.isArray(val)) {
                let parts = [];
                let emptyCount = 0;
                for (let i = 0; i < val.length; i++) {
                    if (i in val) {
                        if (emptyCount > 0) {
                            parts.push(`<${emptyCount} empty items>`);
                            emptyCount = 0;
                        }
                        parts.push(smartStringify(val[i], maxDepth - 1, seen));
                    } else {
                        emptyCount++;
                    }
                }
                if (emptyCount > 0) {
                    parts.push(`<${emptyCount} empty items>`);
                }
                return `[${parts.join(", ")}]`;
            }

            if (typeof val === "function") return `[Function: ${val.name || "(anonymous)"}]`;

            // Regular Object
            try {
                const entries = Object.entries(val);
                if (entries.length === 0) return "{}";
                if (maxDepth === 0) return "{...}";
                const content = entries
                    .map(([k, v]) => `${k}: ${smartStringify(v, maxDepth - 1, seen)}`)
                    .join(", ");
                return `{ ${content} }`;
            } catch (e) {
                return "[Object]";
            }
        };

        const logToConsole = (msg, type = 'info') => {
            if (out.innerHTML.includes('Output will appear')) out.innerHTML = '';

            const div = document.createElement('div');
            let output = smartStringify(msg);

            div.className = `output-line ${type === 'error' ? 'text-red-400' : 'text-green-400'}`;
            const prefix = type === 'user' ? '' : '> ';
            div.textContent = `${prefix}${output}`;

            out.appendChild(div);
            out.scrollTop = out.scrollHeight;
            originalLog(msg);
        };

        // Intercept global console.log
        console.log = (...args) => {
            args.forEach(arg => logToConsole(arg, 'user'));
        };

        // Intercept async errors
        window.onerror = (msg, url, line, col, error) => {
            logToConsole(`Runtime Error: ${msg} (Line: ${line})`, 'error');
            return false;
        };

        // Format Code (Prettier)
        document.getElementById('btn-format').onclick = () => {
            const code = editor.getValue();
            const p = window.prettier || window.Prettier;
            if (!p) {
                logToConsole('Format Error: Prettier not loaded. Please wait or refresh.', 'error');
                return;
            }
            try {
                const formatted = p.format(code, {
                    parser: "babel",
                    plugins: window.prettierPlugins ? Object.values(window.prettierPlugins) : [],
                    singleQuote: true,
                    printWidth: 80,
                    tabWidth: 2,
                });
                editor.setValue(formatted);
                logToConsole('Code formatted successfully.', 'info');
            } catch (err) {
                logToConsole('Format Error: ' + err.message, 'error');
            }
        };

        // Run Code
        document.getElementById('btn-run').onclick = async () => {
            const code = editor.getValue();
            out.innerHTML = '<div class="text-[var(--text-dim)] italic">Executing mission code...</div>';

            // 1. Local Execution for Logs
            try {
                const wrappedCode = `(function() {\n${code}\n})()`;
                const result = eval(wrappedCode);
                if (result !== undefined) {
                    logToConsole(result, 'user');
                }
            } catch (err) {
                logToConsole('Local Execution Error: ' + err.message, 'error');
            }

            // 2. Server Verification for Test Cases
            try {
                const res = await fetch('/api/game/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId, code })
                });
                const data = await res.json();
                if (data.results && data.results.length > 0) {
                    data.results.forEach((r, i) => {
                        logToConsole(`Test Case ${i + 1}: ${r.passed ? 'PASSED' : 'FAILED'} (Expected: ${r.expected}, Got: ${r.actual})`, r.passed ? 'info' : 'error');
                    });
                } else {
                    logToConsole('Verification completed (No test cases defined).', 'info');
                }
            } catch (err) {
                logToConsole('Verification Network Error: ' + err.message, 'error');
            }
        };

        // Submit
        document.getElementById('btn-submit').onclick = async () => {
            const code = editor.getValue();
            const originalText = document.getElementById('btn-submit').innerText;
            document.getElementById('btn-submit').innerText = 'CHECKING...';

            try {
                const res = await fetch('/api/game/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId, code })
                });
                const data = await res.json();
                if (data.success) {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    document.getElementById('success-modal').classList.remove('hidden');
                } else {
                    logToConsole('Verification failed. Check test cases.', 'error');
                }
            } catch (err) {
                alert('Submit failed');
            } finally {
                document.getElementById('btn-submit').innerText = originalText;
            }
        };

        // Master Logic
        const masterBtn = document.getElementById('master-btn');
        const masterChat = document.getElementById('master-chat');
        const closeMaster = document.getElementById('close-master');

        masterBtn.onclick = () => {
            masterChat.style.display = 'flex';
            masterBtn.style.display = 'none';
            document.getElementById('chat-input').focus();
        };

        closeMaster.onclick = () => {
            masterChat.style.display = 'none';
            masterBtn.style.display = 'flex';
        };

        const sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            const chatMessages = document.getElementById('chat-messages');
            const userDiv = document.createElement('div');
            userDiv.className = 'bg-white/10 p-3 rounded-lg text-right';
            userDiv.textContent = msg;
            chatMessages.appendChild(userDiv);
            input.value = '';

            const loading = document.createElement('div');
            loading.className = 'italic opacity-50';
            loading.textContent = 'The Master is thinking...';
            chatMessages.appendChild(loading);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const res = await fetch('/api/game/master', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId, code: editor.getValue(), message: msg })
                });
                const data = await res.json();
                loading.remove();
                const masterDiv = document.createElement('div');
                masterDiv.className = 'bg-[var(--accent)]/10 p-3 rounded-lg border border-[var(--accent)]/20';
                masterDiv.textContent = data.response;
                chatMessages.appendChild(masterDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (err) {
                loading.textContent = 'Connection lost with the Master.';
            }
        };

        document.getElementById('send-chat').onclick = sendMessage;
        document.getElementById('chat-input').onkeypress = (e) => e.key === 'Enter' && sendMessage();

        document.getElementById('btn-next').onclick = () => window.location.href = '/game/map/{{quest.topic}}';
        document.getElementById('btn-skip').onclick = async () => {
            if (confirm('Use skip credit?')) {
                const res = await fetch('/api/game/skip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ questId })
                });
                if (res.ok) window.location.href = '/game/map/{{quest.topic}}';
            }
        };

        lucide.createIcons();
    </script>
</body>

</html>