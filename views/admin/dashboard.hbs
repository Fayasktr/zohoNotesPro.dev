<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <meta name="csrf-token" content="{{csrfToken}}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --accent: #6d5dfc;
            --accent-glow: rgba(109, 93, 252, 0.4);
        }

        * {
            font-family: 'Outfit', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(109, 93, 252, 0.3);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(109, 93, 252, 0.5);
        }
    </style>
</head>

<body class="bg-[#0a0a0c] text-white min-h-screen selection:bg-[#6d5dfc33]">
    <!-- Navbar -->
    <nav
        class="sticky top-0 z-50 bg-[#0a0a0c99] backdrop-blur-xl border-b border-[#ffffff1a] py-4 px-6 lg:px-12 flex justify-between items-center">
        <div
            class="logo text-xl lg:text-2xl font-bold bg-gradient-to-r from-white to-[#6d5dfc] bg-clip-text text-transparent flex items-center gap-3">
            <i data-lucide="shield-check" class="text-[#6d5dfc]"></i>
            Admin Console
        </div>
        <div class="flex items-center gap-4">
            <a href="/"
                class="text-sm font-semibold text-[#a0a0a5] hover:text-white transition-colors flex items-center gap-1.5">
                <i data-lucide="book" class="w-4 h-4"></i>
                Notebook
            </a>
            <div class="hidden sm:block text-sm text-[#a0a0a5]">Welcome, <span
                    class="text-white font-semibold">{{adminName}}</span></div>
            <a href="/logout"
                class="bg-[#ff3b301a] text-[#ff3b30] border border-[#ff3b3033] px-4 py-2 rounded-xl text-sm font-semibold hover:bg-[#ff3b30] hover:text-white transition-all">Logout</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 lg:p-12 w-full">
        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10">
            <div>
                <h1 class="text-3xl font-bold mb-2">User Management</h1>
                <p class="text-[#a0a0a5] text-sm italic">Oversee accounts and monitor activity</p>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="relative w-full sm:w-72 group">
                    <i data-lucide="search"
                        class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-[#a0a0a5] group-focus-within:text-[#6d5dfc] transition-colors"></i>
                    <input type="text" id="userSearch" placeholder="Search users..."
                        class="w-full bg-[#ffffff08] border border-[#ffffff1a] pl-11 pr-4 py-3 rounded-xl outline-none focus:border-[#6d5dfc] focus:ring-4 focus:ring-[#6d5dfc1a] transition-all text-sm"
                        oninput="filterUsers()">
                </div>
                <button onclick="showLogsModal()"
                    class="w-full sm:w-auto bg-[#ffffff08] border border-[#ffffff1a] text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-[#ffffff1a] transition-all">
                    <i data-lucide="terminal" class="w-5 h-5 text-[#6d5dfc]"></i>
                    System Logs
                </button>
                <button onclick="showCreateModal()"
                    class="w-full sm:w-auto bg-[#6d5dfc] text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-[#6d5dfc4d]">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                    Create User
                </button>
                <button onclick="showFeedbackModal()"
                    class="w-full sm:w-auto bg-[#30ff6a] text-[#0a0a0c] px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-[#30ff6a4d]">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                    Feedbacks
                </button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div
                class="glass-card p-6 rounded-3xl border border-[#6d5dfc33] bg-gradient-to-br from-[#6d5dfc1a] to-transparent group hover:scale-[1.02] transition-transform">
                <div class="flex items-center gap-4">
                    <div
                        class="p-4 bg-[#6d5dfc1a] rounded-2xl text-[#6d5dfc] group-hover:bg-[#6d5dfc] group-hover:text-white transition-all">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <div class="text-[10px] text-[#a0a0a5] font-bold uppercase tracking-widest">Total Users</div>
                        <div class="text-3xl font-bold mt-1">{{users.length}}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Table / Mobile Cards -->
        <div class="glass-card rounded-3xl overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse min-w-[700px]">
                    <thead class="bg-[#ffffff08]">
                        <tr>
                            <th class="p-6 text-[#a0a0a5] text-xs font-bold uppercase tracking-wider">User Profile</th>
                            <th class="p-6 text-[#a0a0a5] text-xs font-bold uppercase tracking-wider">Status</th>
                            <th class="p-6 text-[#a0a0a5] text-xs font-bold uppercase tracking-wider">Last Login</th>
                            <th class="p-6 text-[#a0a0a5] text-xs font-bold uppercase tracking-wider">Last Logout</th>
                            <th class="p-6 text-[#a0a0a5] text-xs font-bold uppercase tracking-wider text-right">Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {{#each users}}
                        <tr class="border-b border-[#ffffff08] hover:bg-[#ffffff03] transition-colors group">
                            <td class="p-6">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-10 h-10 bg-[#6d5dfc] rounded-full flex items-center justify-center font-bold text-lg ring-4 ring-[#6d5dfc1a]">
                                        {{substring username 0 1}}
                                    </div>
                                    <div>
                                        <div class="font-semibold">{{username}}</div>
                                        <div class="text-[11px] text-[#a0a0a5]">{{email}}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-6">
                                <span id="status-{{_id}}"
                                    class="px-3 py-1 rounded-full text-[11px] font-bold tracking-wide {{#if isBlocked}}bg-[#ff3b301a] text-[#ff3b30]{{else}}bg-[#30ff6a1a] text-[#30ff6a]{{/if}}">
                                    {{#if isBlocked}}BLOCKED{{else}}ACTIVE{{/if}}
                                </span>
                            </td>
                            <td class="p-6 text-[11px] text-[#a0a0a5] font-mono">
                                {{#if lastLogin}}
                                <div class="flex items-center gap-2">
                                    <i data-lucide="calendar" class="w-3 h-3 text-[#30ff6a]"></i>
                                    {{formatDate lastLogin}}
                                    <!-- Note: I'll add this JS helper below if needed, or just let Handlebars handle it if configured -->
                                </div>
                                {{else}}
                                <span class="opacity-30 italic">No record</span>
                                {{/if}}
                            </td>
                            <td class="p-6 text-[11px] text-[#a0a0a5] font-mono">
                                {{#if lastLogout}}
                                <div class="flex items-center gap-2">
                                    <i data-lucide="log-out" class="w-3 h-3 text-[#ff3b30]"></i>
                                    {{formatDate lastLogout}}
                                </div>
                                {{else}}
                                <span class="opacity-30 italic">No record</span>
                                {{/if}}
                            </td>
                            <td class="p-6">
                                <div class="flex justify-end gap-2">
                                    <button
                                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-[#ffffff08] border border-[#ffffff1a] hover:bg-[#30ff6a] hover:text-white transition-all group/btn"
                                        onclick="viewUserNotes('{{_id}}', '{{username}}')" title="View Notes">
                                        <i data-lucide="book-open" class="w-4 h-4"></i>
                                    </button>
                                    <button
                                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-[#ffffff08] border border-[#ffffff1a] hover:bg-[#6d5dfc] hover:text-white transition-all group/btn"
                                        onclick="showEditModal('{{_id}}', '{{username}}', '{{email}}')"
                                        title="Edit User">
                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                    </button>
                                    <button
                                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-[#ffffff08] border border-[#ffffff1a] hover:bg-[#ff9f0a] hover:text-white transition-all group/btn"
                                        onclick="toggleBlock('{{_id}}')" title="Toggle Block Status">
                                        <i data-lucide="ban" class="w-4 h-4"></i>
                                    </button>
                                    <button
                                        class="w-9 h-9 flex items-center justify-center rounded-lg bg-[#ffffff08] border border-[#ffffff1a] hover:bg-[#ff3b30] hover:text-white transition-all group/btn"
                                        onclick="deleteUser('{{_id}}')" title="Delete User">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- DETAIL VIEW: USER NOTES -->
    <div id="notesDetailView" class="fixed inset-0 z-[1000] hidden">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-md opacity-0 transition-opacity duration-300"
            id="detailOverlay"></div>
        <div class="fixed inset-0 overflow-y-auto p-4 lg:p-12">
            <div class="bg-[#0f0f12] border border-[#ffffff1a] rounded-[2rem] max-w-6xl mx-auto min-h-[85vh] p-8 lg:p-12 relative shadow-2xl translate-y-8 opacity-0 transition-all duration-300 transform"
                id="detailContent">
                <button onclick="closeDetail()" class="absolute top-8 right-8 text-[#a0a0a5] hover:text-white p-2">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>

                <div id="notesHeaderSection">
                    <h2 id="viewUserName" class="text-3xl font-bold mb-4">User's Notes</h2>
                    <div class="flex items-center gap-2 text-sm text-[#a0a0a5] mb-10 bg-[#ffffff05] p-3 rounded-xl w-fit"
                        id="notesBreadcrumb">
                        <!-- Breadcrumbs -->
                    </div>
                </div>

                <div id="notesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Folders and Files -->
                </div>

                <div id="noteContentArea" class="hidden">
                    <div class="flex items-center justify-between mb-8 pb-6 border-b border-[#ffffff1a]">
                        <h2 id="currentOpenedNoteTitle" class="text-2xl font-bold">Note Title</h2>
                        <button onclick="backToNotesList()"
                            class="bg-[#ffffff08] border border-[#ffffff1a] px-6 py-2 rounded-xl text-sm font-semibold hover:bg-[#ffffff1a] transition-all flex items-center gap-2">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                        </button>
                    </div>
                    <div id="noteCellsList" class="space-y-6">
                        <!-- Cells -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: SYSTEM LOGS -->
    <div id="logsModal" class="fixed inset-0 z-[2000] hidden items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300"
            id="logsOverlay"></div>
        <div class="bg-[#151518] border border-[#ffffff1a] p-8 lg:p-10 rounded-[2rem] w-full max-w-2xl relative shadow-2xl scale-95 opacity-0 transition-all duration-300 transform"
            id="logsBox">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold mb-1">System Logs</h2>
                    <p class="text-[#a0a0a5] text-sm italic">Automated maintenance events (Refreshes every 10 min)</p>
                </div>
                <button onclick="clearSystemLogs()"
                    class="bg-[#ff3b301a] text-[#ff3b30] px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-[#ff3b30] hover:text-white transition-all">Clear
                    All</button>
            </div>

            <div id="logsList" class="space-y-3 max-h-[50vh] overflow-y-auto custom-scrollbar pr-2 min-h-[200px]">
                <!-- Logs here -->
            </div>

            <div class="flex gap-4 pt-8">
                <button type="button" onclick="closeLogsModal()"
                    class="w-full px-6 py-4 rounded-xl border border-[#ffffff1a] font-bold hover:bg-[#ffffff08] transition-all">Close</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CREATE / EDIT USER -->
    <div id="userModal" class="fixed inset-0 z-[2000] hidden items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300"
            id="modalOverlay"></div>
        <div class="bg-[#151518] border border-[#ffffff1a] p-8 lg:p-10 rounded-[2rem] w-full max-w-md relative shadow-2xl scale-95 opacity-0 transition-all duration-300 transform"
            id="modalBox">
            <div class="mb-8">
                <h2 id="modalTitle" class="text-2xl font-bold mb-2">Create User</h2>
                <p class="text-[#a0a0a5] text-sm">Fill in the details below</p>
            </div>

            <form id="userForm" class="space-y-6">
                <input type="hidden" id="userId">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-[#a0a0a5] uppercase tracking-wider ml-1">Username</label>
                    <input type="text" id="modalUsername"
                        class="w-full bg-[#ffffff08] border border-[#ffffff1a] p-4 rounded-xl outline-none focus:border-[#6d5dfc] focus:ring-4 focus:ring-[#6d5dfc1a] transition-all"
                        placeholder="Enter username" required>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-[#a0a0a5] uppercase tracking-wider ml-1">Email Address</label>
                    <input type="email" id="modalEmail"
                        class="w-full bg-[#ffffff08] border border-[#ffffff1a] p-4 rounded-xl outline-none focus:border-[#6d5dfc] focus:ring-4 focus:ring-[#6d5dfc1a] transition-all"
                        placeholder="name@example.com" required>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-[#a0a0a5] uppercase tracking-wider ml-1">Password</label>
                    <input type="password" id="modalPassword"
                        class="w-full bg-[#ffffff08] border border-[#ffffff1a] p-4 rounded-xl outline-none focus:border-[#6d5dfc] focus:ring-4 focus:ring-[#6d5dfc1a] transition-all"
                        placeholder="••••••••">
                    <p class="text-[10px] text-[#a0a0a5] mt-1 ml-1" id="pwdHint">Leave blank for no change</p>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-6 py-4 rounded-xl border border-[#ffffff1a] font-bold hover:bg-[#ffffff08] transition-all">Cancel</button>
                    <button type="submit"
                        class="flex-[2] bg-[#6d5dfc] px-6 py-4 rounded-xl font-bold hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-[#6d5dfc4d]">Save
                        User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: USER FEEDBACKS -->
    <div id="feedbackModal" class="fixed inset-0 z-[2000] hidden items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300"
            id="feedbackOverlay"></div>
        <div class="bg-[#151518] border border-[#ffffff1a] p-8 lg:p-10 rounded-[2rem] w-full max-w-2xl relative shadow-2xl scale-95 opacity-0 transition-all duration-300 transform"
            id="feedbackBox">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold mb-1">User Feedbacks</h2>
                    <p class="text-[#a0a0a5] text-sm italic">Latest messages and suggestions from users</p>
                </div>
                <button onclick="closeFeedbackModal()" class="text-[#a0a0a5] hover:text-white"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div id="feedbackList" class="space-y-4 max-h-[50vh] overflow-y-auto custom-scrollbar pr-2 min-h-[200px]">
                <!-- Feedbacks here -->
            </div>

            <div class="flex gap-4 pt-8">
                <button type="button" onclick="closeFeedbackModal()"
                    class="w-full px-6 py-4 rounded-xl border border-[#ffffff1a] font-bold hover:bg-[#ffffff08] transition-all">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const modal = document.getElementById('userModal');
        const detailView = document.getElementById('notesDetailView');
        let userNotesData = [];
        let currentUserId = '';
        let currentUserName = '';

        // Initialize Lucide Icons on Load
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        async function safeFetch(url, options = {}) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const method = (options.method || 'GET').toUpperCase();
            const nonMutating = ['GET', 'HEAD', 'OPTIONS'];

            if (csrfToken && !nonMutating.includes(method)) {
                options.headers = {
                    ...options.headers,
                    'X-CSRF-Token': csrfToken
                };
            }
            const res = await window.fetch(url, options);
            setTimeout(() => lucide.createIcons(), 50); // Small delay to ensure DOM is updated
            return res;
        }

        function filterUsers() {
            const query = document.getElementById('userSearch').value;
            const rows = document.querySelectorAll('#userTableBody tr');

            try {
                const regex = new RegExp(query, 'i');
                rows.forEach(row => {
                    const username = row.querySelector('span.font-semibold').innerText;
                    if (regex.test(username)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            } catch (e) {
                // Invalid regex - just hide nothing or show all
                console.error("Invalid Regex", e);
            }
        }

        function showCreateModal() {
            document.getElementById('modalTitle').innerText = 'Create New User';
            document.getElementById('userId').value = '';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalEmail').value = '';
            document.getElementById('pwdHint').innerText = 'Set a password for the new user';

            const modal = document.getElementById('userModal');
            const overlay = document.getElementById('modalOverlay');
            const box = document.getElementById('modalBox');

            modal.classList.remove('hidden', 'flex');
            modal.classList.add('flex');

            setTimeout(() => {
                overlay.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function showEditModal(id, username, email) {
            document.getElementById('modalTitle').innerText = 'Edit User';
            document.getElementById('userId').value = id;
            document.getElementById('modalUsername').value = username;
            document.getElementById('modalEmail').value = email;
            document.getElementById('pwdHint').innerText = 'Leave blank to keep current password';

            const modal = document.getElementById('userModal');
            const overlay = document.getElementById('modalOverlay');
            const box = document.getElementById('modalBox');

            modal.classList.remove('hidden', 'flex');
            modal.classList.add('flex');

            setTimeout(() => {
                overlay.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('userModal');
            const overlay = document.getElementById('modalOverlay');
            const box = document.getElementById('modalBox');

            overlay.classList.replace('opacity-100', 'opacity-0');
            box.classList.replace('opacity-100', 'opacity-0');
            box.classList.replace('scale-100', 'scale-95');

            setTimeout(() => {
                modal.classList.replace('flex', 'hidden');
            }, 300);
        }

        function closeDetail() {
            const detailView = document.getElementById('notesDetailView');
            const overlay = document.getElementById('detailOverlay');
            const content = document.getElementById('detailContent');

            overlay.classList.replace('opacity-100', 'opacity-0');
            content.classList.replace('opacity-100', 'opacity-0');
            content.classList.replace('translate-y-0', 'translate-y-8');

            setTimeout(() => {
                detailView.classList.add('hidden');
            }, 300);
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('modalUsername').value,
                email: document.getElementById('modalEmail').value,
                password: document.getElementById('modalPassword').value
            };

            const url = id ? `/admin/users/${id}` : '/admin/users';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await safeFetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    location.reload();
                } else {
                    const err = await res.json();
                    alert(err.error);
                }
            } catch (err) {
                alert('Something went wrong');
            }
        });

        async function toggleBlock(id) {
            try {
                const res = await safeFetch(`/admin/users/${id}/toggle-block`, { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById(`status-${id}`);
                    badge.innerText = data.isBlocked ? 'Blocked' : 'Active';
                    badge.className = `status-badge ${data.isBlocked ? 'status-blocked' : 'status-active'}`;
                }
            } catch (err) {
                alert('Failed to update status');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user and all their notes?')) return;
            try {
                const res = await safeFetch(`/admin/users/${id}`, { method: 'DELETE' });
                if (res.ok) location.reload();
            } catch (err) {
                alert('Failed to delete user');
            }
        }

        async function viewUserNotes(id, name) {
            currentUserId = id;
            currentUserName = name;
            document.getElementById('viewUserName').innerText = `${name}'s Notes`;
            const grid = document.getElementById('notesGrid');
            const detailView = document.getElementById('notesDetailView');
            const overlay = document.getElementById('detailOverlay');
            const content = document.getElementById('detailContent');

            grid.innerHTML = '<div class="col-span-full py-20 text-center text-[#a0a0a5]"><i data-lucide="loader-2" class="animate-spin mx-auto w-10 h-10 mb-4 text-[#6d5dfc]"></i><p>Scanning user files...</p></div>';

            detailView.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.replace('opacity-0', 'opacity-100');
                content.classList.replace('opacity-0', 'opacity-100');
                content.classList.replace('translate-y-8', 'translate-y-0');
            }, 10);

            backToNotesList();
            lucide.createIcons();

            try {
                const res = await safeFetch(`/admin/users/${id}/notes`);
                userNotesData = await res.json();
                renderNotesLevel('root');
            } catch (err) {
                grid.innerHTML = '<p style="color: var(--danger);">Error loading notes.</p>';
            }
        }

        function renderNotesLevel(folderName) {
            const grid = document.getElementById('notesGrid');
            const bread = document.getElementById('notesBreadcrumb');
            grid.innerHTML = '';

            // Build Breadcrumb
            bread.innerHTML = `<button onclick="renderNotesLevel('root')" class="hover:text-[#6d5dfc] transition-colors">Root</button>`;
            if (folderName !== 'root') {
                bread.innerHTML += ` <i data-lucide="chevron-right" class="w-3 h-3 mx-1"></i> <span class="text-white font-medium">${folderName}</span>`;
            }
            lucide.createIcons();

            const itemsInLevel = userNotesData.filter(n => (n.folder || 'root') === folderName);

            // If we are at root, show other folders first
            if (folderName === 'root') {
                const folders = [...new Set(userNotesData.map(n => n.folder || 'root'))].filter(f => f !== 'root');
                folders.forEach(f => {
                    const card = document.createElement('div');
                    card.className = 'glass-card p-6 rounded-2xl cursor-pointer hover:bg-[#6d5dfc1a] hover:border-[#6d5dfc33] transition-all flex items-center gap-4 group';
                    card.innerHTML = `
                        <div class="p-3 bg-[#6d5dfc1a] rounded-xl text-[#6d5dfc] group-hover:bg-[#6d5dfc] group-hover:text-white transition-all">
                            <i data-lucide="folder" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-lg truncate">${f}</div>
                            <div class="text-xs text-[#a0a0a5]">${userNotesData.filter(n => n.folder === f).length} Files</div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-[#a0a0a5]"></i>
                    `;
                    card.onclick = () => renderNotesLevel(f);
                    grid.appendChild(card);
                });
            }

            // Show files
            if (itemsInLevel.length === 0 && folderName === 'root' && grid.innerHTML === '') {
                grid.innerHTML = '<p style="color: var(--text-dim);">No notes found for this user.</p>';
                return;
            }

            itemsInLevel.forEach(note => {
                const card = document.createElement('div');
                card.className = 'glass-card p-6 rounded-2xl cursor-pointer hover:border-[#6d5dfc] hover:-translate-y-1 transition-all group';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="p-2 bg-[#ffffff05] rounded-lg text-[#6d5dfc]">
                            <i data-lucide="file-text" class="w-6 h-6"></i>
                        </div>
                        <div class="text-[10px] bg-[#30ff6a1a] text-[#30ff6a] px-2 py-0.5 rounded font-bold">NOTE</div>
                    </div>
                    <h3 class="font-bold text-lg mb-2 truncate">${note.title || 'Untitled'}</h3>
                    <div class="flex items-center gap-2 text-xs text-[#a0a0a5]">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        ${new Date(note.updatedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}
                    </div>
                `;
                card.onclick = () => viewNoteContent(note.id, note.title);
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        async function viewNoteContent(id, title) {
            document.getElementById('notesHeaderSection').style.display = 'none';
            document.getElementById('notesGrid').style.display = 'none';
            const contentArea = document.getElementById('noteContentArea');
            const listArea = document.getElementById('noteCellsList');

            contentArea.style.display = 'block';
            document.getElementById('currentOpenedNoteTitle').innerText = title || 'Untitled Note';
            listArea.innerHTML = '<p>Loading content...</p>';

            try {
                const res = await safeFetch(`/api/notebooks/${id}`);
                const data = await res.json();
                const cells = data.cells || [];
                listArea.innerHTML = '';

                if (cells.length === 0) {
                    listArea.innerHTML = '<div class="py-20 text-center text-[#a0a0a5] bg-[#ffffff03] rounded-3xl border border-dashed border-[#ffffff1a]"><i data-lucide="ghost" class="w-12 h-12 mx-auto mb-4 opacity-20"></i><p>This note is empty.</p></div>';
                } else {
                    cells.forEach(cell => {
                        const cellDiv = document.createElement('div');
                        cellDiv.className = 'bg-[#151518] border border-[#ffffff08] rounded-2xl overflow-hidden';
                        const typeLabel = cell.type === 'markdown' ? 'MARKDOWN' : 'CODE';
                        const titleLabel = cell.title ? `<span class="text-white ml-2">— ${cell.title}</span>` : '';
                        const typeColor = cell.type === 'markdown' ? 'text-[#6d5dfc]' : 'text-[#30ff6a]';

                        cellDiv.innerHTML = `
                            <div class="px-5 py-3 border-b border-[#ffffff08] bg-[#ffffff03] flex items-center text-[10px] font-bold tracking-widest ${typeColor}">
                                <span>${typeLabel}</span>
                                ${titleLabel}
                            </div>
                            <div class="p-6 prose prose-invert max-w-none prose-sm sm:prose-base">
                                ${cell.type === 'markdown' ? marked.parse(cell.content || '') : `<pre class="bg-black/50 p-4 rounded-xl text-sm font-mono overflow-x-auto border border-[#ffffff08]"><code>${escapeHtml(cell.content || '')}</code></pre>`}
                            </div>
                        `;
                        listArea.appendChild(cellDiv);
                    });
                }
                lucide.createIcons();
            } catch (err) {
                listArea.innerHTML = '<p style="color: var(--danger);">Error loading note content.</p>';
            }
        }

        function backToNotesList() {
            document.getElementById('notesHeaderSection').style.display = 'block';
            document.getElementById('notesGrid').style.display = 'grid';
            document.getElementById('noteContentArea').style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closeLogsModal() {
            const modal = document.getElementById('logsModal');
            const overlay = document.getElementById('logsOverlay');
            const box = document.getElementById('logsBox');
            overlay.classList.replace('opacity-100', 'opacity-0');
            box.classList.replace('opacity-100', 'opacity-0');
            box.classList.replace('scale-100', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function showLogsModal() {
            const modal = document.getElementById('logsModal');
            const overlay = document.getElementById('logsOverlay');
            const box = document.getElementById('logsBox');
            const list = document.getElementById('logsList');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            list.innerHTML = '<p class="text-center py-10 opacity-50">Checking history...</p>';

            setTimeout(() => {
                overlay.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('scale-95', 'scale-100');
            }, 10);

            try {
                const res = await safeFetch('/admin/system-logs');
                const logs = await res.json();
                list.innerHTML = '';
                if (logs.length === 0) {
                    list.innerHTML = '<div class="py-10 text-center opacity-30 italic">No events recorded yet.</div>';
                } else {
                    logs.forEach(log => {
                        const date = new Date(log.timestamp).toLocaleString(undefined, {
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        const item = document.createElement('div');
                        item.className = 'bg-[#ffffff03] border border-[#ffffff08] p-4 rounded-xl flex items-start gap-4';

                        const color = log.type === 'error' ? 'text-[#ff3b30]' : 'text-[#6d5dfc]';
                        const icon = log.type === 'error' ? 'alert-circle' : 'activity';

                        item.innerHTML = `
                            <div class="p-2 bg-[#ffffff05] rounded-lg ${color}">
                                <i data-lucide="${icon}" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm leading-relaxed">${log.message}</p>
                                <span class="text-[10px] opacity-40 uppercase font-mono mt-2 block">${date}</span>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
                lucide.createIcons();
            } catch (err) {
                list.innerHTML = '<p class="text-center py-10 text-[#ff3b30]">Failed to load logs.</p>';
            }
        }

        async function showFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            const overlay = document.getElementById('feedbackOverlay');
            const box = document.getElementById('feedbackBox');
            const list = document.getElementById('feedbackList');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            list.innerHTML = '<p class="text-center py-10 opacity-50">Fetching feedbacks...</p>';

            setTimeout(() => {
                overlay.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('opacity-0', 'opacity-100');
                box.classList.replace('scale-95', 'scale-100');
            }, 10);

            try {
                const res = await safeFetch('/api/feedback');
                const feedbacks = await res.json();
                list.innerHTML = '';
                if (feedbacks.length === 0) {
                    list.innerHTML = '<div class="py-10 text-center opacity-30 italic">No feedbacks yet.</div>';
                } else {
                    feedbacks.forEach(f => {
                        const date = new Date(f.createdAt).toLocaleString();
                        const item = document.createElement('div');
                        item.className = 'glass-card border border-[#ffffff1a] p-5 rounded-2xl';
                        item.innerHTML = `
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 bg-[#30ff6a1a] text-[#30ff6a] rounded-full flex items-center justify-center font-bold text-xs">
                                    ${(f.user?.username || '?')[0].toUpperCase()}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-bold truncate">${f.user?.username || 'Unknown'}</div>
                                    <div class="text-[10px] text-[#a0a0a5] truncate">${f.user?.email || ''}</div>
                                </div>
                                <div class="text-[10px] text-[#a0a0a5] font-mono">${date}</div>
                            </div>
                            <p class="text-sm leading-relaxed text-white/90 whitespace-pre-wrap">${f.message}</p>
                        `;
                        list.appendChild(item);
                    });
                }
                lucide.createIcons();
            } catch (err) {
                list.innerHTML = `<p class="text-center py-10 text-[#ff3b30]">Error: ${err.message}</p>`;
            }
        }

        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            const overlay = document.getElementById('feedbackOverlay');
            const box = document.getElementById('feedbackBox');
            overlay.classList.replace('opacity-100', 'opacity-0');
            box.classList.replace('opacity-100', 'opacity-0');
            box.classList.replace('scale-100', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function clearSystemLogs() {
            if (!confirm('Clear all system logs?')) return;
            try {
                const res = await safeFetch('/admin/system-logs/clear', { method: 'POST' });
                if (res.ok) showLogsModal();
            } catch (err) {
                alert('Clear failed');
            }
        }

        // Final check to ensure icons are rendered
        lucide.createIcons();
    </script>
</body>

</html>